@using Kendo.Mvc.UI;
@using WebApplicationNetCoreDev.Helpers;

@model IEnumerable<ApiWykazuPodatnikowVatData.Models.Entity>

@{ string gridName = string.Format("{0}{1}", @System.Reflection.Assembly.GetEntryAssembly().GetName().Name, @System.Reflection.Assembly.GetAssembly(typeof(ApiWykazuPodatnikowVatData.Models.Entity)).GetName().Name); }
@{ string gridActions = string.Format("{0}Actions", gridName); }
@{ string gridDataSource = string.Format("{0}DataSource", gridName); }
@{ string gridToolbarTemplate = string.Format("{0}GridToolbarTemplate", gridName); }
@{ string gridActionApiUrl = string.Format("{0}", "/api/SerwisRzeczypospolitejPolskiej/MinisterstwoFinansow/KrajowaAdministracjaSkarbowa/WykazPodatnikowVatApi/KendoGrid"); }
@{ ViewData["Title"] = "Ministerstwo Finansów - Wykaz podatników VAT"; }
@{ Layout = "~/Views/Shared/_LayoutAdmin.cshtml"; }

<div class="container-fluid k-content m-0">

    <div class="row">

        @(Html.Kendo().Breadcrumb()
            .Name("breadcrumb")
            .Items(items =>
            {
                items.Add()
                .Type(BreadcrumbItemType.RootItem)
                .Href("javascript:void(0)")
                .Text("Ministerstwo Finansów - Wykaz podatników VAT")
                .ShowText(true)
                .Icon("home")
                .ShowIcon(true);
            }))

    </div>

    <div class="row overflow-auto">

        @(Html.Kendo().DataSource<ApiWykazuPodatnikowVatData.Models.Entity>()
            .Name(gridDataSource)
            .Ajax(
                dataSource => dataSource
                .Batch(true)
                .PageSize(100)
                .AutoSync(true)
                .ServerOperation(true)
                .Read(read => read.Url(gridActionApiUrl).Type(HttpVerbs.Get)
            )))
        @(Html.Kendo().Grid<ApiWykazuPodatnikowVatData.Models.Entity>()
            .Name(gridName)
            .Columns(
            columns =>
            {
                //columns.Bound(c => c.Id).Filterable(false);
                columns.Bound(c => c.DateOfCreate).Format("{0:MM-dd-yyyy HH:mm:ss}").Filterable(false);
                columns.Bound(c => c.DateOfModification).Format("{0:MM-dd-yyyy HH:mm:ss}").Filterable(false);
                //columns.Bound(c => c.UniqueIdentifierOfTheLoggedInUser).Filterable(false);
                columns.Bound(c => c.Name).Filterable(false);
                columns.Bound(c => c.Nip).Filterable(false);
                columns.Bound(c => c.StatusVat).Filterable(false);
                columns.Bound(c => c.Regon).Filterable(false);
                columns.Bound(c => c.Pesel).Filterable(false);
                columns.Bound(c => c.Krs).Filterable(false);
                columns.Bound(c => c.ResidenceAddress).Filterable(false);
                columns.Bound(c => c.WorkingAddress).Filterable(false);
                //columns.Bound(c => c.Representatives).Filterable(false);
                //columns.Bound(c => c.Representative).Filterable(false);
                //columns.Bound(c => c.AuthorizedClerks).Filterable(false);
                //columns.Bound(c => c.AuthorizedClerk).Filterable(false);
                //columns.Bound(c => c.Partners).Filterable(false);
                //columns.Bound(c => c.Partner).Filterable(false);
                columns.Bound(c => c.RegistrationLegalDate).Format("{0:MM-dd-yyyy}").Filterable(false);
                //columns.Bound(c => c.RegistrationDenialDate).Format("{0:MM-dd-yyyy}").Filterable(false);
                //columns.Bound(c => c.RegistrationDenialBasis).Filterable(false);
                //columns.Bound(c => c.RestorationDate).Format("{0:MM-dd-yyyy}").Filterable(false);
                //columns.Bound(c => c.RestorationBasis).Filterable(false);
                //columns.Bound(c => c.RemovalDate).Format("{0:MM-dd-yyyy}").Filterable(false);
                //columns.Bound(c => c.RemovalBasis).Filterable(false);
                //columns.Bound(c => c.AccountNumbers).Filterable(false);
                //columns.Bound(c => c.EntityAccountNumber).Filterable(false);
                //columns.Bound(c => c.HasVirtualAccounts).Filterable(false);
            })
            .ToolBar(toolbar =>
            {
                toolbar.ClientTemplateId(gridToolbarTemplate);
            })
            .Sortable()
            .Scrollable()
            .Filterable(filterable => filterable.Extra(false).Operators(operators => operators.ForString(str => str.Clear().IsEqualTo("Jest równy").Contains("Zawiera"))))
            .DataSource(gridDataSource))

        @Html.Script(
            @<script id="@gridToolbarTemplate" type="text/x-kendo-template">
                <div class="toolbar">
                    <div class="row h-100 w-100 p-t-15 align-items-center align-self-center">
                        <div class="col-sm-12 col-md-6 col-lg-3 col-xl-2 mt-n4">
                            @(Html.Kendo().MaskedTextBox().Name("nip").Mask("0000000000").Label(l => l.Content("NIP (10 znaków)").Floating(true)).ToClientTemplate())
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-3 col-xl-2 mt-n4">
                            @(Html.Kendo().MaskedTextBox().Name("regon").Mask("00000000000000").Label(l => l.Content("REGON (9 lub 14 znaków)").Floating(true)).ToClientTemplate())
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-3 col-xl-2 mt-n4">
                            @(Html.Kendo().MaskedTextBox().Name("accountNumber").Mask("00000000000000000000000000").Label(l => l.Content("Numer rachunku bankowego NRB (26 znaków)").Floating(true)).ToClientTemplate())
                        </div>
                        <div class="col-sm-12 col-md-6 col-lg-3 col-xl-6 p-sm-15 p-md-15">
                            <a href="javascript:void(0)" class="k-search k-link k-button k-button-search" title="Wyszukaj"><span class="k-icon k-i-search"></span>Wyszukaj</a>
                            <a href="javascript:void(0)" class="k-pager-refresh k-link k-button k-button-icon" title="Odśwież widok"><span class="k-icon k-i-reload"></span></a>
                        </div>
                    </div>
                </div>
            </script>)

        @Html.Script(
        @<script type="text/javascript">
        $(function () {
            try {
                var grid = $("#@gridName");
                var gridDataSource = @gridDataSource;
                var gridWidget = grid.data("kendoGrid");
                gridWidget.wrapper.height($(".page-wrapper").first().height() * 0.9);
                gridWidget.resize();
                gridWidget.resize(true);
                grid.find(".k-grid-toolbar").on("click", ".k-pager-refresh", function (e) {
                    e.preventDefault();
                    gridDataSource.read();
                }).on("click", ".k-search", function (e) {
                    if (parseInt($("#regon").val(), 10) > 0 || parseInt($("#nip").val(), 10) > 0) {
                        e.preventDefault();
                        var url = gridDataSource.transport.options.read.url;
                        if (parseInt($("#nip").val(), 10) > 0) {
                            gridDataSource.transport.options.read.url = "/api/SerwisRzeczypospolitejPolskiej/MinisterstwoFinansow/KrajowaAdministracjaSkarbowa/WykazPodatnikowVatApi/FindByNipKendoGird/" + $("#nip").val();
                        }
                        else if (parseInt($("#regon").val(), 10) > 0) {
                            gridDataSource.transport.options.read.url = "/api/SerwisRzeczypospolitejPolskiej/MinisterstwoFinansow/KrajowaAdministracjaSkarbowa/WykazPodatnikowVatApi/FindByRegonKendoGird/" + $("#regon").val();
                        }
                        else if (parseInt($("#accountNumber").val(), 10) > 0) {
                            gridDataSource.transport.options.read.url = "/api/SerwisRzeczypospolitejPolskiej/MinisterstwoFinansow/KrajowaAdministracjaSkarbowa/WykazPodatnikowVatApi/FindByAccountNumberKendoGird/" + $("#accountNumber").val();
                        }
                        gridDataSource.read();
                        gridDataSource.transport.options.read.url = url;
                    }
                });
            }
            catch (e) {
                console.log(e);
            }
        });
        </script>)

    </div>
</div>

